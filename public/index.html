<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Search System</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
</head>
<body>
  <div class="container">
    <header class="app-header">
      <h1 class="app-title">Word Search System</h1>
      <p class="app-subtitle">Upload word lists, search for words, and get auto-complete suggestions</p>
    </header>
    
    <!-- File Upload Section -->
    <section class="card">
      <h2 class="card-heading">üìÅ Upload Word List</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="input-group">
          <input type="file" id="wordFile" name="wordfile" accept=".txt" />
          <button type="submit" id="uploadBtn">Upload</button>
        </div>
      </form>
      <div id="uploadStatus" class="status"></div>
    </section>
    
    <!-- Auto-Complete Section -->
    <section class="card">
      <h2 class="card-heading">üîÆ Auto-Complete</h2>
      <div class="input-group">
        <input type="text" id="prefixInput" placeholder="Enter prefix (max 20 characters)" maxlength="20" />
      </div>
      <ul id="suggestions"></ul>
    </section>
    
    <!-- Search Section -->
    <section class="card">
      <h2 class="card-heading">üîç Search Word</h2>
      <div class="input-group">
        <input type="text" id="searchInput" placeholder="Enter word to search (max 50 characters)" maxlength="50" />
        <button id="searchBtn">Search</button>
      </div>
      <div id="searchResult" class="result"></div>
    </section>
    
    <!-- Rank Check Section -->
    <section class="card">
      <h2 class="card-heading">üèÜ Check Rank</h2>
      <div class="input-group">
        <input type="text" id="rankInput" placeholder="Enter word to check rank" maxlength="50" />
        <button id="rankBtn">Check</button>
      </div>
      <div id="rankResult" class="result"></div>
    </section>
  </div>

  <!-- Theme Toggle -->
  <div class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </div>
  
  <script>
    // Theme toggle functionality
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        themeToggle.innerHTML = document.body.classList.contains('dark-mode') 
          ? '<i class="fas fa-sun"></i>' 
          : '<i class="fas fa-moon"></i>';
      });
    });
    
    // File Upload Handler
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const fileInput = document.getElementById('wordFile');
      const statusDiv = document.getElementById('uploadStatus');
      
      if (!fileInput.files[0]) {
        statusDiv.textContent = "Please select a file.";
        statusDiv.className = "status error";
        return;
      }
      
      const formData = new FormData();
      formData.append("wordfile", fileInput.files[0]);
      
      try {
        statusDiv.textContent = "Uploading...";
        statusDiv.className = "status";
        
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        if (response.ok) {
          statusDiv.textContent = `‚úÖ ${result.message} (${result.invalidCount} invalid entries ignored)`;
          statusDiv.className = "status success";
        } else {
          statusDiv.textContent = `‚ùå ${result.error}`;
          statusDiv.className = "status error";
        }
      } catch (err) {
        console.error("Upload error:", err);
        statusDiv.textContent = "‚ùå Upload failed. Please try again.";
        statusDiv.className = "status error";
      }
    });
    
    // Debounce utility for auto-complete
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }
    
    // Auto-Complete Handler
    document.getElementById('prefixInput').addEventListener('input', debounce(async function(e) {
      const prefix = e.target.value;
      const suggestionsList = document.getElementById('suggestions');
      if (prefix.length < 1) {
        suggestionsList.innerHTML = "";
        return;
      }
      try {
        const response = await fetch(`/api/autocomplete?prefix=${encodeURIComponent(prefix)}`);
        const data = await response.json();
        suggestionsList.innerHTML = data.suggestions.map(word => `<li>${word}</li>`).join("");
        // Attach click events to suggestions
        Array.from(suggestionsList.getElementsByTagName('li')).forEach(item => {
          item.addEventListener('click', function() {
            document.getElementById('prefixInput').value = this.textContent;
            suggestionsList.innerHTML = "";
          });
        });
      } catch (err) {
        console.error("Error fetching suggestions:", err);
      }
    }, 300));
    
    // Search Handler
    document.getElementById('searchBtn').addEventListener('click', async function() {
      const searchValue = document.getElementById('searchInput').value;
      const resultDiv = document.getElementById('searchResult');
      if (!searchValue) {
        resultDiv.textContent = "Please enter a word to search.";
        resultDiv.className = "result error";
        return;
      }
      try {
        const response = await fetch(`/api/search?word=${encodeURIComponent(searchValue)}`);
        const data = await response.json();
        if (data.exists) {
          resultDiv.textContent = `"${data.word}" found! Rank: ${data.rank}`;
          resultDiv.className = "result success";
        } else {
          resultDiv.textContent = `"${data.word}" not found.`;
          resultDiv.className = "result error";
        }
      } catch (err) {
        console.error("Search error:", err);
        resultDiv.textContent = "Search failed. Please try again.";
        resultDiv.className = "result error";
      }
    });
    
    // Rank Check Handler
    document.getElementById('rankBtn').addEventListener('click', async function() {
      const rankValue = document.getElementById('rankInput').value;
      const rankResultDiv = document.getElementById('rankResult');
      if (!rankValue) {
        rankResultDiv.textContent = "Please enter a word to check rank.";
        rankResultDiv.className = "result error";
        return;
      }
      try {
        const response = await fetch(`/api/rank?word=${encodeURIComponent(rankValue)}`);
        if (response.ok) {
          const data = await response.json();
          rankResultDiv.textContent = `Rank of "${data.word}": ${data.rank}`;
          rankResultDiv.className = "result success";
        } else {
          rankResultDiv.textContent = `Word not found.`;
          rankResultDiv.className = "result error";
        }
      } catch (err) {
        console.error("Rank check error:", err);
        rankResultDiv.textContent = "Rank check failed. Please try again.";
        rankResultDiv.className = "result error";
      }
    });
  </script>
</body>
</html>
